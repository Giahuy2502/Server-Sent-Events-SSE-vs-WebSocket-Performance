<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üöÄ Complete SSE vs WebSocket Demo</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background-color: #f5f5f5;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .feature-tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .tab-button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .tab-button.active {
      background-color: #0056b3;
    }
    
    .tab-button:hover {
      background-color: #0056b3;
    }
    
    .status-bar {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .status-item {
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .status-connected {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .status-fallback {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .main-dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .server-panel {
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .sse-panel {
      border-color: #007bff;
    }
    
    .ws-panel {
      border-color: #28a745;
    }
    
    .panel-header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .panel-header h2 {
      margin: 0;
      color: #333;
    }
    
    .data-display {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .data-value {
      font-size: 3em;
      font-weight: bold;
      color: #007bff;
      margin: 10px 0;
    }
    
    .ws-panel .data-value {
      color: #28a745;
    }
    
    .data-time {
      color: #666;
      font-size: 0.9em;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .metric-box {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
    }
    
    .metric-label {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 5px;
    }
    
    .metric-value {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }
    
    .performance-section {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .comparison-table th,
    .comparison-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .comparison-table th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    
    .latency-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .latency-box {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 5px;
      text-align: center;
    }
    
    .latency-value {
      font-size: 2em;
      font-weight: bold;
      color: #007bff;
    }
    
    .controls {
      text-align: center;
      margin-top: 20px;
    }
    
    .control-button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 0 10px;
      font-size: 1em;
    }
    
    .control-button:hover {
      background-color: #0056b3;
    }
    
    .log-section {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.8em;
    }

    /* C√°c n√∫t ƒëi·ªÅu khi·ªÉn k·∫øt n·ªëi */
    .connection-controls {
      margin: 15px 0;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .connection-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
      font-size: 0.9em;
    }
    
    .connect-btn {
      background-color: #28a745;
      color: white;
    }
    
    .connect-btn:hover {
      background-color: #218838;
    }
    
    .connect-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    .disconnect-btn {
      background-color: #dc3545;
      color: white;
    }
    
    .disconnect-btn:hover {
      background-color: #c82333;
    }
    
    .disconnect-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .connection-status {
      padding: 5px 10px;
      border-radius: 3px;
      font-weight: bold;
      margin: 5px 0;
      text-align: center;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üöÄ SSE vs WebSocket Performance Dashboard</h1>
    <p>Real-time comparison of Server-Sent Events and WebSocket performance</p>
  </div>

  <div class="status-bar">
    <div class="status-item" id="sseStatus">SSE: Connecting...</div>
    <div class="status-item" id="wsStatus">WebSocket: Connecting...</div>
  </div>

  <div class="main-dashboard">
    <!-- SSE Panel -->
    <div class="server-panel sse-panel">
      <div class="panel-header">
        <h2>üì° Server-Sent Events (SSE)</h2>
        <div class="connection-status status-disconnected" id="sseConnectionStatus">Disconnected</div>
        <div class="connection-controls">
          <button class="connection-btn connect-btn" id="sseConnectBtn" onclick="connectSSE()">üîó Connect</button>
          <button class="connection-btn disconnect-btn" id="sseDisconnectBtn" onclick="disconnectSSE()" disabled>‚ùå Disconnect</button>
        </div>
      </div>
      
      <div class="data-display">
        <div class="data-value" id="sseValue">--</div>
        <div class="data-time" id="sseTime">Waiting for data...</div>
      </div>
      
      <div class="metrics-grid">
        <div class="metric-box">
          <div class="metric-label">Connections</div>
          <div class="metric-value" id="sseConnections">0</div>
        </div>
        <div class="metric-box">
          <div class="metric-label">Messages</div>
          <div class="metric-value" id="sseMessages">0</div>
        </div>
        <div class="metric-box">
          <div class="metric-label">Throughput (msg/s)</div>
          <div class="metric-value" id="sseThroughput">0</div>
        </div>
        <div class="metric-box">
          <div class="metric-label">Uptime (s)</div>
          <div class="metric-value" id="sseUptime">0</div>
        </div>
      </div>
    </div>

    <!-- WebSocket Panel -->
    <div class="server-panel ws-panel">
      <div class="panel-header">
        <h2>üîå WebSocket</h2>
        <div class="connection-status status-disconnected" id="wsConnectionStatus">Disconnected</div>
        <div class="connection-controls">
          <button class="connection-btn connect-btn" id="wsConnectBtn" onclick="connectWebSocket()">üîó Connect</button>
          <button class="connection-btn disconnect-btn" id="wsDisconnectBtn" onclick="disconnectWebSocket()" disabled>‚ùå Disconnect</button>
        </div>
      </div>
      
      <div class="data-display">
        <div class="data-value" id="wsValue">--</div>
        <div class="data-time" id="wsTime">Waiting for data...</div>
      </div>
      
      <div class="metrics-grid">
        <div class="metric-box">
          <div class="metric-label">Connections</div>
          <div class="metric-value" id="wsConnections">0</div>
        </div>
        <div class="metric-box">
          <div class="metric-label">Messages</div>
          <div class="metric-value" id="wsMessages">0</div>
        </div>
        <div class="metric-box">
          <div class="metric-label">Throughput (msg/s)</div>
          <div class="metric-value" id="wsThroughput">0</div>
        </div>
        <div class="metric-box">
          <div class="metric-label">Uptime (s)</div>
          <div class="metric-value" id="wsUptime">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Comparison -->
  <div class="performance-section">
    <h3>üìä Performance Comparison</h3>
    <table class="comparison-table">
      <thead>
        <tr>
          <th>Metric</th>
          <th>SSE</th>
          <th>WebSocket</th>
          <th>Winner</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>CPU Usage (%)</td>
          <td id="sseCpuUsage">--</td>
          <td id="wsCpuUsage">--</td>
          <td id="cpuWinner">--</td>
        </tr>
        <tr>
          <td>Memory Usage (%)</td>
          <td id="sseMemoryUsage">--</td>
          <td id="wsMemoryUsage">--</td>
          <td id="memoryWinner">--</td>
        </tr>
        <tr>
          <td>Throughput (msg/s)</td>
          <td id="sseThroughputComp">--</td>
          <td id="wsThroughputComp">--</td>
          <td id="throughputWinner">--</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Latency Testing -->
  <div class="performance-section">
    <h3>‚ö° Latency Testing</h3>
    <div class="latency-section">
      <div class="latency-box">
        <div class="metric-label">SSE Latency</div>
        <div class="latency-value" id="sseLatency">-- ms</div>
      </div>
      <div class="latency-box">
        <div class="metric-label">WebSocket Latency</div>
        <div class="latency-value" id="wsLatency">-- ms</div>
      </div>
    </div>
    
    <div class="controls">
      <button class="control-button" onclick="testLatency()">Test Latency</button>
      <button class="control-button" onclick="clearLogs()">Clear Logs</button>
    </div>
  </div>

  <!-- Activity Log -->
  <div class="performance-section">
    <h3>üìù Activity Log</h3>
    <div class="log-section" id="activityLog">
      <div>Dashboard initialized...</div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // Bi·∫øn theo d√µi hi·ªáu su·∫•t
    let sseLatency = 0;
    let wsLatency = 0;
    let ssePerformanceData = {};
    let wsPerformanceData = {};

    // Bi·∫øn theo d√µi tr·∫°ng th√°i k·∫øt n·ªëi
    let sseConnected = false;
    let wsConnected = false;
    let sseSource = null;
    let ws = null;
    let ssePerformanceSource = null;

    // C√°c h√†m ti·ªán √≠ch
    function log(message) {
      const logDiv = document.getElementById('activityLog');
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div>[${time}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(element, status, isConnected) {
      element.className = 'status-item ' + (isConnected ? 'status-connected' : 'status-disconnected');
      element.textContent = status;
    }

    // Qu·∫£n l√Ω tr·∫°ng th√°i k·∫øt n·ªëi
    function updateConnectionUI(type, connected) {
      const connectBtn = document.getElementById(`${type}ConnectBtn`);
      const disconnectBtn = document.getElementById(`${type}DisconnectBtn`);
      const connectionStatus = document.getElementById(`${type}ConnectionStatus`);
      
      if (connected) {
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        connectionStatus.textContent = 'ƒê√£ k·∫øt n·ªëi';
        connectionStatus.className = 'connection-status status-connected';
      } else {
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        connectionStatus.textContent = 'Ch∆∞a k·∫øt n·ªëi';
        connectionStatus.className = 'connection-status status-disconnected';
      }
    }

    function updateComparison() {
      // So s√°nh m·ª©c s·ª≠ d·ª•ng CPU
      if (ssePerformanceData.cpu_usage !== undefined && wsPerformanceData.cpu_usage !== undefined) {
        document.getElementById('sseCpuUsage').textContent = ssePerformanceData.cpu_usage + '%';
        document.getElementById('wsCpuUsage').textContent = wsPerformanceData.cpu_usage + '%';
        document.getElementById('cpuWinner').textContent = 
          ssePerformanceData.cpu_usage < wsPerformanceData.cpu_usage ? 'SSE' : 'WebSocket';
      }

      // So s√°nh m·ª©c s·ª≠ d·ª•ng b·ªô nh·ªõ
      if (ssePerformanceData.memory_usage !== undefined && wsPerformanceData.memory_usage !== undefined) {
        document.getElementById('sseMemoryUsage').textContent = ssePerformanceData.memory_usage + '%';
        document.getElementById('wsMemoryUsage').textContent = wsPerformanceData.memory_usage + '%';
        document.getElementById('memoryWinner').textContent = 
          ssePerformanceData.memory_usage < wsPerformanceData.memory_usage ? 'SSE' : 'WebSocket';
      }

      // So s√°nh th√¥ng l∆∞·ª£ng
      if (ssePerformanceData.throughput !== undefined && wsPerformanceData.throughput !== undefined) {
        document.getElementById('sseThroughputComp').textContent = ssePerformanceData.throughput;
        document.getElementById('wsThroughputComp').textContent = wsPerformanceData.throughput;
        document.getElementById('throughputWinner').textContent = 
          ssePerformanceData.throughput > wsPerformanceData.throughput ? 'SSE' : 'WebSocket';
      }
    }

    // K·∫øt n·ªëi SSE
    const sseStatus = document.getElementById('sseStatus');

    function connectSSE() {
      if (sseConnected) {
        log('SSE already connected');
        return;
      }

      try {
        log('Connecting to SSE...');
        sseSource = new EventSource("http://127.0.0.1:5000/stream");
        
        sseSource.onopen = () => {
          sseConnected = true;
          updateStatus(sseStatus, 'SSE: Connected ‚úÖ', true);
          updateConnectionUI('sse', true);
          log('SSE connected successfully');
        };

        sseSource.onmessage = event => {
          const data = JSON.parse(event.data);
          document.getElementById("sseValue").textContent = data.value;
          document.getElementById("sseTime").textContent = "Updated at " + data.timestamp;
          
          // T√≠nh to√°n ƒë·ªô tr·ªÖ cho SSE
          if (data.send_time) {
            sseLatency = Math.round((Date.now() / 1000 - data.send_time) * 1000);
            document.getElementById("sseLatency").textContent = sseLatency + " ms";
          }
        };

        sseSource.onerror = () => {
          sseConnected = false;
          updateStatus(sseStatus, 'SSE: Connection Error ‚ùå', false);
          updateConnectionUI('sse', false);
          log('SSE connection error');
        };

        // Lu·ªìng d·ªØ li·ªáu hi·ªáu su·∫•t
        ssePerformanceSource = new EventSource("http://127.0.0.1:5000/performance");
        ssePerformanceSource.onmessage = event => {
          const data = JSON.parse(event.data);
          ssePerformanceData = data;
          
          document.getElementById("sseConnections").textContent = data.connections;
          document.getElementById("sseMessages").textContent = data.messages_sent;
          document.getElementById("sseThroughput").textContent = data.throughput;
          document.getElementById("sseUptime").textContent = data.uptime;
          
          updateComparison();
        };

      } catch (error) {
        sseConnected = false;
        updateStatus(sseStatus, 'SSE: Failed to Connect ‚ùå', false);
        updateConnectionUI('sse', false);
        log('SSE connection failed: ' + error.message);
      }
    }

    function disconnectSSE() {
      if (!sseConnected) {
        log('SSE already disconnected');
        return;
      }

      try {
        if (sseSource) {
          sseSource.close();
          sseSource = null;
        }
        if (ssePerformanceSource) {
          ssePerformanceSource.close();
          ssePerformanceSource = null;
        }
        
        sseConnected = false;
        updateStatus(sseStatus, 'SSE: Disconnected ‚è∏Ô∏è', false);
        updateConnectionUI('sse', false);
        
        // X√≥a hi·ªÉn th·ªã d·ªØ li·ªáu
        document.getElementById("sseValue").textContent = '--';
        document.getElementById("sseTime").textContent = 'Disconnected';
        
        log('SSE disconnected manually');
      } catch (error) {
        log('Error disconnecting SSE: ' + error.message);
      }
    }

    // K·∫øt n·ªëi WebSocket
    const wsStatus = document.getElementById('wsStatus');

    function connectWebSocket() {
      if (wsConnected) {
        log('WebSocket already connected');
        return;
      }

      try {
        log('Connecting to WebSocket...');
        ws = io("http://127.0.0.1:8080", {
          transports: ["websocket", "polling"],
          reconnectionAttempts: 5,
          reconnectionDelay: 1000
        });

        ws.on("connect", () => {
          wsConnected = true;
          updateStatus(wsStatus, 'WebSocket: Connected ‚úÖ', true);
          updateConnectionUI('ws', true);
          log('WebSocket connected successfully');
        });

        ws.on("connect_error", (err) => {
          wsConnected = false;
          updateStatus(wsStatus, 'WebSocket: Connection Error ‚ùå', false);
          updateConnectionUI('ws', false);
          log('WebSocket connection error: ' + err.message);
        });

        ws.on("disconnect", (reason) => {
          wsConnected = false;
          updateStatus(wsStatus, 'WebSocket: Disconnected ‚ö†Ô∏è', false);
          updateConnectionUI('ws', false);
          log('WebSocket disconnected: ' + reason);
        });

        ws.on("update", (data) => {
          document.getElementById("wsValue").textContent = data.value;
          document.getElementById("wsTime").textContent = "Updated at " + data.timestamp;
          
          // T√≠nh to√°n ƒë·ªô tr·ªÖ cho WebSocket
          if (data.send_time) {
            wsLatency = Math.round((Date.now() / 1000 - data.send_time) * 1000);
            document.getElementById("wsLatency").textContent = wsLatency + " ms";
          }
        });

        ws.on("performance", (data) => {
          wsPerformanceData = data;
          
          document.getElementById("wsConnections").textContent = data.connections;
          document.getElementById("wsMessages").textContent = data.messages_sent;
          document.getElementById("wsThroughput").textContent = data.throughput;
          document.getElementById("wsUptime").textContent = data.uptime;
          
          updateComparison();
        });

        ws.on("pong", (data) => {
          const latency = Math.round((Date.now() / 1000 - data.client_time) * 1000);
          document.getElementById("wsLatency").textContent = latency + " ms";
          log(`WebSocket ping-pong latency: ${latency}ms`);
        });

      } catch (error) {
        wsConnected = false;
        updateStatus(wsStatus, 'WebSocket: Failed to Connect ‚ùå', false);
        updateConnectionUI('ws', false);
        log('WebSocket connection failed: ' + error.message);
      }
    }

    function disconnectWebSocket() {
      if (!wsConnected) {
        log('WebSocket already disconnected');
        return;
      }

      try {
        if (ws && ws.connected) {
          ws.disconnect();
        }
        
        wsConnected = false;
        updateStatus(wsStatus, 'WebSocket: Disconnected ‚è∏Ô∏è', false);
        updateConnectionUI('ws', false);
        
        // X√≥a hi·ªÉn th·ªã d·ªØ li·ªáu
        document.getElementById("wsValue").textContent = '--';
        document.getElementById("wsTime").textContent = 'Disconnected';
        
        log('WebSocket disconnected manually');
      } catch (error) {
        log('Error disconnecting WebSocket: ' + error.message);
      }
    }

    // C√°c h√†m ƒëi·ªÅu khi·ªÉn
    function testLatency() {
      log('Testing latency...');
      
      // Ki·ªÉm tra ƒë·ªô tr·ªÖ WebSocket v·ªõi ping-pong
      if (ws && ws.connected) {
        ws.emit("ping", { timestamp: Date.now() / 1000 });
      }
      
      // SSE latency is measured automatically from send_time
      setTimeout(() => {
        log(`Latency test completed - SSE: ${sseLatency}ms, WebSocket: ${wsLatency}ms`);
      }, 100);
    }

    function clearLogs() {
      document.getElementById('activityLog').innerHTML = '<div>Logs cleared...</div>';
    }  
    // Initialize UI state
    log('Dashboard initialized. Use Connect buttons to start connections.');
    updateConnectionUI('sse', false);
    updateConnectionUI('ws', false);

    // Auto-refresh stats every 5 seconds
    setInterval(() => {
      if (ws && ws.connected) {
        ws.emit("get_stats");
      }
    }, 5000);

  </script>
</body>
</html>